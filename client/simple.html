<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartCrop AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .upload-zone {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-zone:hover {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }
        .platform-card {
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .platform-card:hover {
            border-color: #3b82f6;
        }
        .platform-card.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .progress-bar {
            width: 100%;
            height: 0.5rem;
            background-color: #e5e7eb;
            border-radius: 0.25rem;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #3b82f6;
            transition: width 0.3s ease;
        }
        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .preview-content {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .preview-image {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
        }
        .result-card {
            transition: transform 0.2s ease;
        }
        .result-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <h1 class="text-2xl font-bold text-gray-900">üé® SmartCrop AI</h1>
                <p class="text-gray-600">AI-powered media resizing for social platforms</p>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Hero Section -->
            <div class="text-center mb-12">
                <h2 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">
                    Resize Your Media for
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600"> Every Platform</span>
                </h2>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                    Upload once, get perfect sizes for Instagram, TikTok, YouTube, Facebook, LinkedIn, and more. 
                    AI-powered smart cropping keeps your content looking great everywhere.
                </p>
            </div>

            <!-- Upload Form -->
            <form id="uploadForm" class="mb-8">
                <div class="upload-zone mb-6" onclick="document.getElementById('fileInput').click()">
                    <input id="fileInput" type="file" accept="image/*,video/*" class="hidden" required>
                    <div id="uploadText">
                        <p class="text-lg font-medium text-gray-900">üìÅ Drop your media here</p>
                        <p class="text-gray-600">or click to browse files</p>
                        <p class="text-sm text-gray-500 mt-2">Supports images and videos up to 500MB</p>
                    </div>
                </div>

                <!-- Platform Selection -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Select Platform Formats</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Instagram -->
                        <div class="bg-white rounded-lg border-2 border-gray-200 p-4">
                            <div class="flex items-center mb-3">
                                <span class="text-2xl mr-3">üì∑</span>
                                <h4 class="font-semibold text-gray-900">Instagram</h4>
                            </div>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="format-checkbox mr-2" data-platform="instagram" data-format="Square" checked>
                                    <span class="text-sm">Square (1080√ó1080) - 1:1</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="format-checkbox mr-2" data-platform="instagram" data-format="Story" checked>
                                    <span class="text-sm">Story (1080√ó1920) - 9:16</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="format-checkbox mr-2" data-platform="instagram" data-format="Reel">
                                    <span class="text-sm">Reel (1080√ó1920) - 9:16</span>
                                </label>
                            </div>
                        </div>

                        <!-- Facebook -->
                        <div class="bg-white rounded-lg border-2 border-gray-200 p-4">
                            <div class="flex items-center mb-3">
                                <span class="text-2xl mr-3">üë•</span>
                                <h4 class="font-semibold text-gray-900">Facebook</h4>
                            </div>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="format-checkbox mr-2" data-platform="facebook" data-format="Feed" checked>
                                    <span class="text-sm">Feed (1200√ó1500) - 4:5</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="format-checkbox mr-2" data-platform="facebook" data-format="Story">
                                    <span class="text-sm">Story (1080√ó1920) - 9:16</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="format-checkbox mr-2" data-platform="facebook" data-format="Video">
                                    <span class="text-sm">Video (1920√ó1080) - 16:9</span>
                                </label>
                            </div>
                        </div>

                        <!-- TikTok -->
                        <div class="bg-white rounded-lg border-2 border-gray-200 p-4">
                            <div class="flex items-center mb-3">
                                <span class="text-2xl mr-3">üéµ</span>
                                <h4 class="font-semibold text-gray-900">TikTok</h4>
                            </div>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="format-checkbox mr-2" data-platform="tiktok" data-format="Video">
                                    <span class="text-sm">Video (1080√ó1920) - 9:16</span>
                                </label>
                            </div>
                        </div>

                        <!-- YouTube -->
                        <div class="bg-white rounded-lg border-2 border-gray-200 p-4">
                            <div class="flex items-center mb-3">
                                <span class="text-2xl mr-3">üì∫</span>
                                <h4 class="font-semibold text-gray-900">YouTube</h4>
                            </div>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="format-checkbox mr-2" data-platform="youtube" data-format="Video">
                                    <span class="text-sm">Video (1920√ó1080) - 16:9</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="format-checkbox mr-2" data-platform="youtube" data-format="Thumbnail">
                                    <span class="text-sm">Thumbnail (1280√ó720) - 16:9</span>
                                </label>
                            </div>
                        </div>

                        <!-- LinkedIn -->
                        <div class="bg-white rounded-lg border-2 border-gray-200 p-4">
                            <div class="flex items-center mb-3">
                                <span class="text-2xl mr-3">üíº</span>
                                <h4 class="font-semibold text-gray-900">LinkedIn</h4>
                            </div>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="format-checkbox mr-2" data-platform="linkedin" data-format="Post">
                                    <span class="text-sm">Post (1200√ó628) - 1.91:1</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="format-checkbox mr-2" data-platform="linkedin" data-format="Video">
                                    <span class="text-sm">Video (1920√ó1080) - 16:9</span>
                                </label>
                            </div>
                        </div>

                        <!-- Pinterest -->
                        <div class="bg-white rounded-lg border-2 border-gray-200 p-4">
                            <div class="flex items-center mb-3">
                                <span class="text-2xl mr-3">üìå</span>
                                <h4 class="font-semibold text-gray-900">Pinterest</h4>
                            </div>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="format-checkbox mr-2" data-platform="pinterest" data-format="Pin">
                                    <span class="text-sm">Pin (1000√ó1500) - 2:3</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="format-checkbox mr-2" data-platform="pinterest" data-format="Idea Pin">
                                    <span class="text-sm">Idea Pin (1080√ó1920) - 9:16</span>
                                </label>
                            </div>
                        </div>

                        <!-- X/Twitter -->
                        <div class="bg-white rounded-lg border-2 border-gray-200 p-4">
                            <div class="flex items-center mb-3">
                                <span class="text-2xl mr-3">üê¶</span>
                                <h4 class="font-semibold text-gray-900">X/Twitter</h4>
                            </div>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="format-checkbox mr-2" data-platform="twitter" data-format="Post">
                                    <span class="text-sm">Post (1920√ó1080) - 16:9</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="format-checkbox mr-2" data-platform="twitter" data-format="Header">
                                    <span class="text-sm">Header (1500√ó500) - 3:1</span>
                                </label>
                            </div>
                        </div>

                        <!-- Website -->
                        <div class="bg-white rounded-lg border-2 border-gray-200 p-4">
                            <div class="flex items-center mb-3">
                                <span class="text-2xl mr-3">üåê</span>
                                <h4 class="font-semibold text-gray-900">Website</h4>
                            </div>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="format-checkbox mr-2" data-platform="website" data-format="Banner">
                                    <span class="text-sm">Banner (2560√ó1080) - 21:9</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="format-checkbox mr-2" data-platform="website" data-format="Hero">
                                    <span class="text-sm">Hero (1920√ó1080) - 16:9</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Process Button -->
                <div class="text-center mb-8">
                    <button type="submit" id="processBtn" class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-3 px-8 rounded-lg text-lg transition-colors">
                        üöÄ Process Media
                    </button>
                </div>
            </form>

            <!-- Progress -->
            <div id="progressSection" class="mb-8 hidden">
                <div class="text-center mb-4">
                    <p class="text-lg font-medium text-gray-900">Processing your media...</p>
                    <p class="text-gray-600"><span id="progressText">0</span>% complete</p>
                </div>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                </div>
            </div>

            <!-- Results -->
            <div id="resultsSection" class="mb-8 hidden">
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-bold text-green-600 mb-2">‚úÖ Processing Complete!</h3>
                    <p class="text-gray-600">Your media has been optimized for all selected platforms</p>
                </div>
                <div id="resultsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Results will be populated here -->
                </div>
            </div>

            <!-- Features -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="text-center">
                    <div class="text-4xl mb-4">ü§ñ</div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">AI-Powered Smart Crop</h3>
                    <p class="text-gray-600">Automatically detects and keeps important subjects in frame across all aspect ratios.</p>
                </div>
                <div class="text-center">
                    <div class="text-4xl mb-4">üì±</div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Multi-Platform Output</h3>
                    <p class="text-gray-600">Generate perfect sizes for Instagram, TikTok, YouTube, Facebook, LinkedIn, and more in one click.</p>
                </div>
                <div class="text-center">
                    <div class="text-4xl mb-4">‚ö°</div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Optimized File Sizes</h3>
                    <p class="text-gray-600">Automatic compression and optimization ensures fast uploads while maintaining quality.</p>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-white border-t mt-16">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="text-center text-gray-600">
                    <p>¬© 2024 SmartCrop AI. Powered by OpenAI and advanced computer vision.</p>
                </div>
            </div>
        </footer>
    </div>

    <script>
        console.log('SmartCrop AI loading...');
        
        let selectedFile = null;
        let currentJob = null;
        
        // File input handling
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                document.getElementById('uploadText').innerHTML = `
                    <p class="text-lg font-medium text-gray-900">‚úÖ ${file.name}</p>
                    <p class="text-gray-600">Click to change file</p>
                `;
                hideResults();
            }
        });

        // Format checkbox handling - no additional logic needed as checkboxes handle themselves

        // Form submission
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!selectedFile) {
                alert('Please select a file first');
                return;
            }

            const selectedFormats = Array.from(document.querySelectorAll('.format-checkbox:checked'));

            if (selectedFormats.length === 0) {
                alert('Please select at least one format');
                return;
            }

            // Group selected formats by platform
            const platformsData = {};
            selectedFormats.forEach(checkbox => {
                const platform = checkbox.dataset.platform;
                if (!platformsData[platform]) {
                    platformsData[platform] = [];
                }
                platformsData[platform].push(checkbox.dataset.format);
            });

            const selectedPlatforms = Object.keys(platformsData);

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('selectedFormats', JSON.stringify(platformsData));

            showProgress();
            
            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const job = await response.json();
                currentJob = job;

                if (response.ok) {
                    pollProgress(job.id);
                } else {
                    throw new Error(job.message || 'Upload failed');
                }
            } catch (error) {
                alert('Upload failed: ' + error.message);
                hideProgress();
            }
        });

        function showProgress() {
            document.getElementById('processBtn').disabled = true;
            document.getElementById('processBtn').textContent = '‚è≥ Processing...';
            document.getElementById('progressSection').classList.remove('hidden');
            hideResults();
        }

        function hideProgress() {
            document.getElementById('processBtn').disabled = false;
            document.getElementById('processBtn').textContent = 'üöÄ Process Media';
            document.getElementById('progressSection').classList.add('hidden');
        }

        function hideResults() {
            document.getElementById('resultsSection').classList.add('hidden');
        }

        function updateProgress(progress) {
            document.getElementById('progressText').textContent = progress;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        async function pollProgress(jobId) {
            try {
                const response = await fetch(`/api/jobs/${jobId}`);
                const job = await response.json();

                updateProgress(job.progress);

                if (job.status === 'completed') {
                    hideProgress();
                    showResults(job.results);
                } else if (job.status === 'failed') {
                    hideProgress();
                    alert('Processing failed: ' + (job.error || 'Unknown error'));
                } else {
                    setTimeout(() => pollProgress(jobId), 2000);
                }
            } catch (error) {
                console.error('Error polling progress:', error);
                setTimeout(() => pollProgress(jobId), 2000);
            }
        }

        function showResults(results) {
            console.log('Showing results:', results);
            console.log('Current job:', currentJob);

            const resultsGrid = document.getElementById('resultsGrid');
            resultsGrid.innerHTML = '';

            results.forEach((result, index) => {
                const filename = result.filePath.split('/').pop();
                console.log('Processing result:', { result, filename, currentJobId: currentJob?.id });

                const resultCard = document.createElement('div');
                resultCard.className = 'result-card bg-white rounded-lg shadow-lg p-6 border border-gray-200';
                resultCard.innerHTML = `
                    <div class="text-center mb-4">
                        <div class="w-16 h-16 mx-auto mb-3 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                            <span class="text-white text-xl font-bold">${getPlatformIcon(result.platform)}</span>
                        </div>
                        <h4 class="font-bold text-gray-900 text-lg">${result.platform}</h4>
                        <p class="text-blue-600 font-medium">${result.format}</p>
                        <p class="text-sm text-gray-500">${result.dimensions.width} √ó ${result.dimensions.height}</p>
                        <p class="text-xs text-gray-400 mt-1">${formatFileSize(result.fileSize)}</p>
                    </div>

                    <div class="space-y-2">
                        <button onclick="previewFile('${currentJob.id}', '${filename}', '${result.platform}', '${result.format}')"
                                class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            üëÅÔ∏è Preview
                        </button>
                        <button onclick="downloadFile('${currentJob.id}', '${filename}')"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            üì• Download
                        </button>
                    </div>
                `;
                resultsGrid.appendChild(resultCard);
            });

            document.getElementById('resultsSection').classList.remove('hidden');
        }

        function getPlatformIcon(platform) {
            const icons = {
                'Instagram': 'üì∑',
                'Facebook': 'üë•',
                'TikTok': 'üéµ',
                'YouTube': 'üì∫',
                'LinkedIn': 'üíº',
                'Pinterest': 'üìå',
                'X/Twitter': 'üê¶',
                'Website': 'üåê'
            };
            return icons[platform] || 'üì±';
        }

        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function previewFile(jobId, filename, platform, format) {
            const previewUrl = `/api/download/${jobId}/${filename}`;

            // Close any existing preview
            if (window.currentPreviewModal) {
                closePreview();
            }

            // Create modal
            const modal = document.createElement('div');
            modal.className = 'preview-modal';
            modal.style.display = 'flex'; // Ensure it's visible
            modal.innerHTML = `
                <div class="preview-content">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">${platform} - ${format}</h3>
                            <p class="text-gray-600">Preview</p>
                        </div>
                        <button onclick="closePreview()" class="text-gray-500 hover:text-gray-700 text-2xl font-bold px-2 py-1 rounded">√ó</button>
                    </div>
                    <div class="text-center">
                        <img src="${previewUrl}" alt="${platform} ${format}" class="preview-image rounded-lg shadow-lg">
                    </div>
                    <div class="mt-4 text-center space-x-2">
                        <button onclick="closePreview()"
                                class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium">
                            Close
                        </button>
                        <button onclick="downloadFile('${jobId}', '${filename}')"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium">
                            üì• Download
                        </button>
                    </div>
                </div>
            `;

            // Add click outside to close
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closePreview();
                }
            });

            document.body.appendChild(modal);
            window.currentPreviewModal = modal;
        }

        function closePreview() {
            if (window.currentPreviewModal) {
                try {
                    document.body.removeChild(window.currentPreviewModal);
                    window.currentPreviewModal = null;
                } catch (error) {
                    console.error('Error closing preview:', error);
                    window.currentPreviewModal = null;
                }
            }
        }

        function downloadFile(jobId, filename) {
            const link = document.createElement('a');
            link.href = `/api/download/${jobId}/${filename}`;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Keyboard support for closing preview
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && window.currentPreviewModal) {
                closePreview();
            }
        });



        console.log('SmartCrop AI loaded successfully!');
    </script>
</body>
</html>
